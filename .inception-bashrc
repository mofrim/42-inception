# vim: ft=bash

# wrapped color-escape sequences... needed for readline to get the prompt prefix
# length right.
RED='\[\e[31m\]'
GREEN='\[\e[32m\]'
BLUE='\[\e[34m\]'
CYAN='\[\e[36m\]'
BRCYAN='\[\e[1;96m\]'
GRAY='\[\e[37m\]'
RESET='\[\e[0m\]'


function shorten_path() {
  local path_level=$(pwd | sed 's/[^\/]//g' | wc -c)
  if [ $path_level -gt 3 ]; then
    pwd | sed 's/.*\/\([a-zA-Z0-9_-]\+\)\/\([a-zA-Z0-9_-]\+\)\/\([a-zA-Z0-9_-]\+\)$/\1\/\2\/\3/'
  else
    pwd
  fi
}

export INCEPTION_SHELL="ok"
export INCEP_TOOLDIR="$inception_root/tools"

if [[ -z $VM_INSTALL_SHELL && -z $VM_RUN_SHELL ]]; then
  echo
  echo -e '\e[1;96m((( Welcome to the inception-env! )))\e[0m'
  echo
  export PS1="(${GREEN}\u${CYAN}@${BLUE}inception${RESET}) ${GRAY}\$(shorten_path \w)::${RESET} "
elif [ -n "$VM_RUN_SHELL" ]; then
  alias killvm='kill $INCEPTION_VM_PID'
  alias ssh_to_vm='ssh-keygen -f "/home/$(id -un)/.ssh/known_hosts" -R "[localhost]:5555"; ssh -q -o StrictHostKeyChecking=no -p 5555 fmaurer@localhost'
  PS1="\n${BRCYAN}((( '${GREEN}killvm${BRCYAN}' and '${GREEN}ssh_to_vm${BRCYAN}' cmds available )))\n"
  PS1="$PS1((( run 'exit' or press ctrl-d when finished! )))${RESET}\n"
  export PS1="$PS1(${GREEN}\u${CYAN}@${BLUE}inception${RED}RunVM${RESET}) ${GRAY}::${RESET} "
else
  alias killvm='kill $INCEPTION_VM_PID'
  alias ssh_to_vm='ssh-keygen -f "/home/$(id -un)/.ssh/known_hosts" -R "[localhost]:5555"; ssh -q -o StrictHostKeyChecking=no -p 5555 root@localhost'
  alias setup_vm_system='./0a_setup_vm_system.sh'
  PS1="\n${BRCYAN}((( when root pw is set in vm, just run '${GREEN}setup_vm_system${BRCYAN}' )))\n"
  PS1="$PS1((( finally: run '${GREEN}exit${BRCYAN}' or press ctrl-d to launch vm )))${RESET}\n"
  export PS1="$PS1(${GREEN}\u${CYAN}@${BLUE}inception${RED}InstallVM${RESET}) ${GRAY}::${RESET} "
fi

